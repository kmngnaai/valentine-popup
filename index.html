<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Valentine's For Keiii</title>

<style>
body{
    margin:0;
    min-height:100vh;
    background:url("valentines-mobile.png") center/cover no-repeat #f6d6df;
    display:flex;
    justify-content:center;
    align-items:center;
    font-family:"Segoe UI","Helvetica Neue",Arial,sans-serif;
    overflow:hidden;
    transition:.6s;
}

/* Overlay */
body::before{
    content:"";
    position:fixed;
    inset:0;
    background:rgba(0,0,0,.22);
    z-index:0;
    transition:.6s;
    pointer-events:none; /* TH√äM D√íNG N√ÄY */
}


.dark::before{
    background:rgba(0,0,0,.55);
}

/* ================= STICKER ================= */
.sticker{
    position:fixed;
    pointer-events:auto;
    z-index:1;
    opacity:0;
    animation:life 4.8s ease-in-out forwards;
    transition:opacity .6s;

    transform: scale(1); /* üëà th√™m d√≤ng n√†y */
}

.letter-open .sticker{
    opacity:.15 !important;
}

@keyframes life{
    0%   {opacity:0;}
    25%  {opacity:1;}
    75%  {opacity:1;}
    100% {opacity:0;}
}

/* Panda */
.panda{
    animation:
        life 4.8s ease-in-out forwards,
        pandaGlow 4.8s ease-in-out forwards;
}

@keyframes pandaGlow{

    /* Fade in 1.2s */
    0%   {filter:drop-shadow(0 0 0px rgba(255,192,203,0));}
    25%  {filter:drop-shadow(0 0 12px rgba(255,192,203,0.9));}

    /* Gi·ªØ 2.4s ‚Äì nh·ªãp tim nh·∫π */
    40%  {filter:drop-shadow(0 0 18px rgba(255,192,203,1));}
    60%  {filter:drop-shadow(0 0 14px rgba(255,192,203,0.9));}
    75%  {filter:drop-shadow(0 0 16px rgba(255,192,203,1));}

    /* Fade out 1.2s */
    100% {filter:drop-shadow(0 0 0px rgba(255,192,203,0));}
}

.panda:active{
    transform:scale(0.7);
    transition:transform .15s ease;
}

/* ================= POPUP ================= */
.pink-box{
    position:relative;
    z-index:2;
    width:min(92vw,460px);
    padding:30px 26px 34px;
    background:linear-gradient(180deg,#fff9fc,#fff2f7);
    border-radius:26px;
    border:2px solid #f0b7d3;
    box-shadow:0 14px 36px rgba(0,0,0,.28);
    text-align:center;
}

.heart{
    font-size:46px;
    margin-bottom:10px;
    animation:beat 2.2s infinite;
}

.text{
    font-size:22px;
    font-weight:600;
    color:#7a1f47;
    white-space: pre-line;   /* üëà th√™m d√≤ng n√†y */
}


.btn{
    margin-top:22px;
    padding:10px 48px;
    font-size:17px;
    background:linear-gradient(180deg,#f7c4de,#f2aecd);
    border:none;
    border-radius:999px;
    cursor:pointer;
    color:#4d0f2d;
}

.hidden{display:none}
@keyframes beat{30%{transform:scale(1.1)}}

/* ================= LOVE TEXT ================= */
.love-text{
    position:fixed;
    font-size:26px;
    font-weight:900;
    pointer-events:none;
    z-index:4;
    animation:loveFloat 1.4s ease-out forwards;
}

@keyframes loveFloat{
    0%{
        opacity:0;
        transform:translate(0,0) scale(.8);
    }
    25%{opacity:1;}
    100%{
        opacity:0;
        transform:translate(var(--flyX), var(--flyY)) scale(1.3);
    }
}

.flying-heart{
    position:fixed;
    pointer-events:none;
    z-index:3;
    animation:heartFly 1.6s ease-out forwards;
}

@keyframes heartFly{
    0%{opacity:1; transform:translate(0,0) scale(.8);}
    100%{opacity:0; transform:translate(var(--x),var(--y)) scale(1.8);}
}

/* ================= PHONG TH∆Ø ================= */
.envelope{
    position:fixed;
    font-size:70px;
    z-index:10;
    top:45%;
    left:50%;
    transform:translate(-50%,-50%);
    cursor:pointer;
    transition:transform 0.3s ease;
}

/* khi xu·∫•t hi·ªán m·ªõi r∆°i */
.envelope.drop{
    animation:drop 1.2s ease forwards;
}

.envelope:active{
    transform:translate(-50%,-50%) scale(0.95);
}


@keyframes shake{
    0%{transform:translateX(-50%) rotate(0deg);}
    25%{transform:translateX(-50%) rotate(3deg);}
    50%{transform:translateX(-50%) rotate(-3deg);}
    75%{transform:translateX(-50%) rotate(2deg);}
    100%{transform:translateX(-50%) rotate(0deg);}
}

@keyframes drop{
    to{ top:45%; }
}

/* ================= L√Å TH∆Ø ================= */
/* ================= L√Å TH∆Ø OVERLAY ================= */
.letter{
    position:fixed;
    inset:0;
    z-index:5000;

    display:flex;
    justify-content:center;
    align-items:center;

    background:rgba(0,0,0,0.35);

    pointer-events:none;
    opacity:0;
    transition:.4s ease;
}

.letter.show{
    pointer-events:auto;
    opacity:1;
}

/* Card n·ªïi */
.letter-card{
    width:min(96vw,720px);
    height:50vh;
    max-height:85vh;

    overflow-y:auto;
    scroll-behavior:smooth;

    /* üå∏ n·ªÅn gi·∫•y h·ªìng pastel */
    background:
        radial-gradient(circle at top,
        #fff0f6 0%,
        #ffe6f1 60%,
        #ffd9ea 100%);

    border-radius:26px;
    padding:80px 26px 40px;

    /* üíó vi·ªÅn m·ªÅm */
    border:2px solid #ffc2da;

    /* ‚ú® ph√°t s√°ng + n·ªïi */
    box-shadow:
        0 0 40px rgba(255,105,180,0.35),
        0 30px 70px rgba(194, 24, 91, 0.25);

    position:relative;

    animation: letterGlow 3s ease-in-out infinite alternate;
}

@keyframes letterGlow{
    from{
        box-shadow:
            0 0 30px rgba(255,105,180,0.25),
            0 25px 60px rgba(194, 24, 91, 0.20);
    }
    to{
        box-shadow:
            0 0 65px rgba(255,105,180,0.45),
            0 35px 80px rgba(194, 24, 91, 0.30);
    }
}


.letter-card h2{
    text-align:center;
    margin-bottom:18px;
    font-size:28px;
    font-weight:600;   /* gi·∫£m ƒë·∫≠m */
    color:#c2185b;
}

.letter-card div{
    font-size:27px !important;
    line-height:1.5;
    margin-bottom:3px;
    font-weight:400;

    -webkit-text-size-adjust: 100%;
    text-size-adjust: 100%;

    transform: translateZ(0);
}


/* N√∫t ƒë√≥ng c·ªë ƒë·ªãnh */
.close-btn{
    position:absolute;   /* ƒë·ªïi t·ª´ sticky -> absolute */
    top:20px;
    right:20px;

    background:#ffe6f1;
    border:none;
    border-radius:30px;
    padding:8px 18px;

    font-weight:600;
    cursor:pointer;
    color:#c2185b;

    box-shadow:0 5px 15px rgba(0,0,0,.15);
}




/* ===== Con tr·ªè tim nh·∫•p nh√°y ===== */
.cursor-heart{
    display:inline-block;
    margin-left:4px;
    font-size:22px;
    animation:blinkCursor 1.2s infinite, heartBeatCursor 2.2s infinite;
}

@keyframes blinkCursor{
    0%,100%{opacity:1;}
    50%{opacity:0;}
}

@keyframes heartBeatCursor{
    30%{transform:scale(1.2);}
}
/* ================= BG HEART FLOAT ================= */
.bg-heart{
    position:fixed;
    font-size:22px;
    opacity:0.08;
    pointer-events:none;
    z-index:19;
    animation:bgFloat linear forwards;
}

@keyframes bgFloat{
    from{transform:translateY(100vh);}
    to{transform:translateY(-120vh);}
}

/* ===== Sticker bounce t·ª± do ===== */
/* ===== Ripple ===== */
.ripple{
    position:fixed;
    border-radius:50%;
    pointer-events:none;
    z-index:2;
    animation:rippleEffect 0.8s ease-out forwards;
}

@keyframes rippleEffect{
    0%{
        width:20px;
        height:20px;
        opacity:0.6;
        transform:translate(-50%,-50%) scale(0.5);
    }
    100%{
        width:200px;
        height:200px;
        opacity:0;
        transform:translate(-50%,-50%) scale(1.2);
    }
}

/* ===== Sparkle ===== */
.sparkle{
    position:fixed;
    pointer-events:none;
    font-size:14px;
    animation:sparkleFly 0.8s ease-out forwards;
}

@keyframes sparkleFly{
    0%{opacity:1; transform:translate(0,0) scale(0.5);}
    100%{opacity:0; transform:translate(var(--sx),var(--sy)) scale(1.4);}
}

/* ===== Sticker happy shake ===== */
@keyframes stickerHappy {
    0%   {transform: scale(1) rotate(0deg);}
    20%  {transform: scale(1.3) rotate(-12deg);}
    40%  {transform: scale(1.25) rotate(12deg);}
    60%  {transform: scale(1.3) rotate(-10deg);}
    80%  {transform: scale(1.25) rotate(10deg);}
    100% {transform: scale(1) rotate(0deg);}
}
/* ===== Charge Love (3 l·∫ßn) ===== */
@keyframes stickerCharge {
    0%   {transform: scale(1) rotate(0deg);}
    40%  {transform: scale(1.35) rotate(8deg);}
    70%  {transform: scale(1.28) rotate(-6deg);}
    100% {transform: scale(1) rotate(0deg);}
}

/* ===== Energy Pulse (4 l·∫ßn) ===== */
@keyframes stickerPulse {
    0%   {transform: scale(1);}
    20%  {transform: scale(1.2);}
    40%  {transform: scale(0.95);}
    60%  {transform: scale(1.15);}
    80%  {transform: scale(0.98);}
    100% {transform: scale(1);}
}

.charge-effect{
    animation-name: stickerCharge;
    animation-duration: 0.6s;
    animation-timing-function: ease;
    animation-fill-mode: forwards;
}

.pulse-effect{
    animation-name: stickerPulse;
    animation-duration: 0.5s;
    animation-timing-function: ease;
    animation-fill-mode: forwards;
}

/* ================= LOVE ENERGY SYSTEM ================= */

#loveBarWrapper{
    position:fixed;
    bottom:20px;
    left:50%;
    transform:translateX(-50%);
    width:80%;
    max-width:500px;
    z-index:2000;
    text-align:center;

    opacity:0;              /* üëà TH√äM */
    pointer-events:none;    /* üëà TH√äM */
    transition:0.4s;
}



#loveBar{
    position:relative;
    height:22px;
    background:rgba(255,255,255,0.4);
    border-radius:30px;
    overflow:hidden;
    box-shadow:0 0 15px rgba(255,105,180,0.3);
    animation:heartBeatBar 2s infinite;
}

@keyframes heartBeatBar{
    0%,100%{transform:scale(1);}
    30%{transform:scale(1.03);}
}

#loveFill{
    height:100%;
    width:0%;
    background:linear-gradient(90deg,#ff6ec7,#ff9ad5);
    border-radius:30px;
    transition:width 0.4s ease;
}

#loveSparkle{
    position:absolute;
    inset:0;
    background:linear-gradient(
        120deg,
        transparent 20%,
        rgba(255,255,255,0.6) 50%,
        transparent 80%
    );
    background-size:200% 100%;
    animation:sparkleMove 3s linear infinite;
}

@keyframes sparkleMove{
    from{background-position:-200% 0;}
    to{background-position:200% 0;}
}

#lovePanda{
    position:absolute;
    top:-28px;
    left:0%;
    font-size:22px;
    transition:left 0.4s ease;
}

#loveText{
    margin-top:6px;
    font-weight:700;
    color:#c2185b;
}

@keyframes pandaRain{

    0%{
        transform:translateY(-200px) scale(0.6) rotate(0deg);
        opacity:0;
    }

    10%{
        opacity:1;
    }

    50%{
        transform:translateY(60vh) scale(1) rotate(180deg);
    }

    100%{
        transform:translateY(120vh) scale(1.05) rotate(360deg);
        opacity:0;
    }
}


img[style*="pandaRain"]{
    will-change: transform;
}





@keyframes popSoft{
    0%{
        transform:translate(-50%,-50%) scale(0.8);
        opacity:0;
    }
    100%{
        transform:translate(-50%,-50%) scale(1);
        opacity:1;
    }
}



</style>
</head>

<body>

<div id="popup1" class="pink-box">
    <div class="heart">üíó</div>
    <div id="text1" class="text"></div>
    <button class="btn" onclick="nextPopup()">ok</button>
</div>

<div id="popup2" class="pink-box hidden">
    <div class="heart">üíì</div>
    <div id="text2" class="text"></div>
    <button class="btn" onclick="closePopup()">ok</button>
</div>

<div id="envelope" class="envelope hidden">üíå</div>
<!-- LOVE ENERGY BAR -->
<div id="loveBarWrapper">
    <div id="loveBar">
        <div id="loveFill"></div>
        <div id="loveSparkle"></div>
        <div id="lovePanda">üêº</div>
    </div>
    <div id="loveText">0%</div>
</div>



<div id="letter" class="letter">

    <div class="letter-card">

        <button id="closeLetterBtn" class="close-btn">
             üíó  ƒê√≥ng th∆∞
        </button>

        <h2>14.02.2026</h2>

        <div id="letterContent"></div>

    </div>

</div>



<script>

/* ================= RANDOM MESSAGE ================= */

const loveMessages = [
"Ki·ªÅu ∆°ii, Em y√™u Ki·ªÅu",
"Em y√™u ch·ªã qu√≥ √≤",
"Ki·ªÅu ∆°i, Em nh·ªõ Ki·ªÅu",
"Em nh·ªõ ch·ªã qu√≥ √≤",
"em y√™u b√© Keii nh·∫•t tr√™n ƒë·ªùii",
"b√© Keii c·ªßa R√πa",
"y√™u Keii",
"Ki·ªÅu ∆°i, moa moaaa",
"c·ª•c c∆∞ng ∆°i, mu·ªën √¥m √¥m",
"√¥m √¥m",
"y√™u Ki·ªÅu",
"y√™u ch·ªã",
"nh·ªõ Ki·ªÅu",
"nh·ªõ ch·ªã",
"Umoaa umoazz",
"ch·ª•t ch·ª•ttt",
"hun hun hun",
"hun ch·ª•c c√°ii",
"h√≠t h√≠tt",
"d·ª£ ∆°ii, √¥m m√≠nn",
"d·ª£ ∆°i, em m·ª£tt",
"d·ª£ ∆°ii, ƒë·ª´ng d·ªói em m√≤aa",
"d·ª£ ∆°ii, cho b√© c·∫°p m√≠nn",
"th∆°m th∆°m ng∆∞·ªùi y√™u n√†",
"c·ª•c c∆∞ng ngoan ngoan",
"em th∆∞∆°nggg Ki·ªÅuu",
"em mu·ªën √¥m √¥m",
"d·ª£ iuu ∆°ii",
"em y√™u d·ª£",
"d·ª£ ∆°ii, √¥m √¥m",
"d·ª£ ∆°ii, ƒÉn ƒÉn ƒÉnnn",
"d·ª£ ∆°ii, em ƒë√≥ii",
"c·ª•c c∆∞ng ∆°i, em th∆∞∆°ng em th∆∞∆°ng",
"d·ª£ ∆°i, mu·ªën hun hunn",
"c·ª•c c∆∞ng ∆°i, mu·ªën ch·ªã",
"c·ª•c c∆∞ng c·ª•c c∆∞ng em y√™u ch·ªã",
"c·ª•c c∆∞ng ∆°i, mu·ªën ƒÉn g√¨ d·∫°",
"c·ª•c c∆∞ng c√≥ nh·ªõ em h√¥ng d·∫°",
"c·ª•c c∆∞ng c√≥ y√™u em h√¥ng d·∫°",
"em y√™u ch·ªã nhi·ªÅu l·∫Øm lu√¥n √°",
"d·ª£ ∆°ii, em y√™u ch·ªã",
"ng∆∞·ªùi y√™u ∆°ii, nh·ªõ ƒÉn s√°ng nhaa",
"c·ª•c c∆∞ng ∆°i, nh·ªõ ƒÉn ƒë·∫ßy ƒë·ªß nha"
];



let lastIndex=-1;
let stickerInterval = null;
let bgInterval = null;
let pandaPool = [];
let normalPool = [];
/* ================= LOVE ENERGY ================= */

let loveScore = 0;
let loveLevel = 1;

const loveFill = document.getElementById("loveFill");
const loveText = document.getElementById("loveText");
const lovePanda = document.getElementById("lovePanda");

updateLoveBar(); // üëà CHUY·ªÇN XU·ªêNG ƒê√ÇY



function updateLoveBar(){

    let percent = loveScore;

    if(percent > 100) percent = 100;

    loveFill.style.width = percent + "%";
    loveText.textContent = percent + "%";

    lovePanda.style.left = `calc(${percent}% - 10px)`;



    /* üíó ƒë·ªïi m√†u theo m·ª©c y√™u */
    if(percent < 40){
        loveFill.style.background =
        "linear-gradient(90deg,#ff6ec7,#ff9ad5)";
    }
    else if(percent < 80){
        loveFill.style.background =
        "linear-gradient(90deg,#ff4db8,#ff7ac9)";
    }
    else{
        loveFill.style.background =
        "linear-gradient(90deg,#ff0080,#ff4da6)";
    }

    /* üî• 100% FULL */
    if(loveScore >= 100){
        fullLove();
    }
}

function fullLove(){

    loveScore = 0;
    loveLevel++;

    /* üí• Confetti tim */
    for(let i=0;i<40;i++){
        const heart=document.createElement("div");
        heart.textContent="üíñ";
        heart.style.position="fixed";
        heart.style.left=Math.random()*100+"vw";
        heart.style.top="-20px";
        heart.style.fontSize="22px";
        heart.style.animation="bgFloat 2s linear forwards";
        document.body.appendChild(heart);
        setTimeout(()=>heart.remove(),2000);
    }

    /* üå∏ n·ªÅn s√°ng 2s */
    document.body.style.filter="brightness(1.15)";
    setTimeout(()=>{
        document.body.style.filter="";
    },2000);

    const msg=document.createElement("div");

msg.textContent =
"üêº B√© R√πa ƒë∆∞·ª£c b√© Keii y√™u full 100% lu√¥n r·ªìi ƒë√≥oo üíó";

msg.style.position="fixed";
msg.style.top="45%";
msg.style.left="50%";
msg.style.transform="translate(-50%,-50%)";

msg.style.padding="20px 32px";
msg.style.borderRadius="30px";

msg.style.background=
"linear-gradient(135deg,#fff8fc,#ffe6f3,#ffd6ec)";

msg.style.fontSize="26px";
msg.style.fontWeight="600";
msg.style.letterSpacing="0.5px";

msg.style.color="#d63384";

msg.style.textShadow=
"0 0 15px rgba(255,182,193,0.6)";

msg.style.boxShadow=
"0 20px 60px rgba(255,105,180,0.25)";

msg.style.zIndex="9999";
msg.style.animation="popSoft 0.6s ease";

document.body.appendChild(msg);



    setTimeout(()=>{
        msg.remove();
    },3000);

    /* üî• l√™n level Ultra Love */
    loveFill.style.background =
    "linear-gradient(90deg,#a100ff,#d580ff)";
}


const envelope = document.getElementById("envelope");
const letter = document.getElementById("letter");
const letterContent = document.getElementById("letterContent");
const popup1 = document.getElementById("popup1");
const popup2 = document.getElementById("popup2");
const closeLetterBtn = document.getElementById("closeLetterBtn");

/* ================= TYPE WRITER ================= */

function typeWriter(element, text, speed = 55){

    return new Promise(resolve => {

        element.textContent = "";
        let i = 0;

        function typing(){
            if(i < text.length){
                element.textContent += text[i];
                i++;
                setTimeout(typing, speed);
            } else {
                resolve();
            }
        }

        typing();
    });
}








function getRandomMessage(){
    let index;
    do{
        index=Math.floor(Math.random()*loveMessages.length);
    }while(index===lastIndex);
    lastIndex=index;
    return loveMessages[index];
}

/* ================= AUTO PASTEL COLOR ================= */

function generateCuteColor(){
    const hue=Math.floor(Math.random()*360);
    const saturation=85;   // t∆∞∆°i
    const lightness=65;    // ƒë·ªß s√°ng ƒë·ªÉ r√µ
    return `hsl(${hue},${saturation}%,${lightness}%)`;
}

/* ================= STICKER ENGINE ================= */

function rand(min,max){return Math.random()*(max-min)+min;}
function randInt(min,max){return Math.floor(rand(min,max));}
function shuffleArray(array){
    for(let i = array.length - 1; i > 0; i--){
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
}
function initPools(){

    pandaPool = [];
    for(let i=1;i<=23;i++){
        pandaPool.push(i);
    }
    shuffleArray(pandaPool);

    normalPool = [];
    for(let i=1;i<=47;i++){
        normalPool.push(i);
    }
    shuffleArray(normalPool);
}

// üëá PH·∫¢I ƒê·∫∂T RA NGO√ÄI
function preloadSmart(){

    // clone pool
    const normalQueue = [...normalPool];
    const pandaQueue  = [...pandaPool];

    // wave ƒë·∫ßu
    const firstBatch = [
        ...normalQueue.slice(0,10).map(id => ({id, type:"normal"})),
        ...pandaQueue.slice(0,5).map(id => ({id, type:"panda"}))
    ];

    // ph·∫ßn c√≤n l·∫°i
    const remainingBatch = [
        ...normalQueue.slice(10).map(id => ({id, type:"normal"})),
        ...pandaQueue.slice(5).map(id => ({id, type:"panda"}))
    ];

    // ===== preload wave ƒë·∫ßu ngay =====
    firstBatch.forEach(item=>{
        const img = new Image();

        if(item.type === "normal"){
            img.src = `webp-stickers/${item.id}.webp`;
        }else{
            img.src = `webp-stickers-panda/${item.id}.webp`;
        }
    });

    // ===== preload ph·∫ßn c√≤n l·∫°i t·ª´ t·ª´ =====
    let index = 0;

    function loadNext(){
        if(index >= remainingBatch.length) return;

        const item = remainingBatch[index];
        const img = new Image();

        if(item.type === "normal"){
            img.src = `webp-stickers/${item.id}.webp`;
        }else{
            img.src = `webp-stickers-panda/${item.id}.webp`;
        }

        index++;
        setTimeout(loadNext, 80);
    }

    setTimeout(loadNext, 1000);
}




function getGridPositions(){

    const positions = [];
    const totalNeeded = 15; // 10 th∆∞·ªùng + 5 panda
    const minDistance = window.innerWidth < 768 ? 90 : 120;

 // kho·∫£ng c√°ch t·ªëi thi·ªÉu gi·ªØa sticker

    const centerYMin = innerHeight * 0.35;
    const centerYMax = innerHeight * 0.65;

    let attempts = 0;

    while(positions.length < totalNeeded && attempts < 1200){
        attempts++;

        let x = rand(40, innerWidth - 80);
        let y = rand(40, innerHeight - 80);

        // tr√°nh v√πng popup gi·ªØa mobile
        if(window.innerWidth < 768){
            if(y > centerYMin && y < centerYMax){
                continue;
            }
        }

        let tooClose = false;

        for(let p of positions){
            let dx = p.x - x;
            let dy = p.y - y;
            let distance = Math.sqrt(dx*dx + dy*dy);

            if(distance < minDistance){
                tooClose = true;
                break;
            }
        }

        if(!tooClose){
            positions.push({x,y});
        }
    }

    return shuffleArray(positions);
}
function spawnBgHeart(){
    const h = document.createElement("div");
    h.className="bg-heart";
    h.textContent="üíó";

    h.style.left = rand(0,innerWidth)+"px";
    h.style.fontSize = rand(16,28)+"px";
    h.style.animationDuration = rand(6,12)+"s";

    document.body.appendChild(h);

    setTimeout(()=>h.remove(),12000);
}

function showLove(x,y, sticker){

    sticker.dataset.clicks++;
    const count = parseInt(sticker.dataset.clicks);
    loveScore += 1;
updateLoveBar();

/* üêº m·ªói 20 tick m∆∞a panda */
if(loveScore % 20 === 0){

    for(let i=0;i<35;i++){

        const panda = document.createElement("img");

        // l·∫•y random panda t·ª´ pool 1‚Äì23
        const randomId = Math.floor(Math.random()*23) + 1;
        panda.src = `webp-stickers-panda/${randomId}.webp`;

        panda.style.position = "fixed";

        // random ngang
        panda.style.left = Math.random()*100 + "vw";

        // random cao b·∫Øt ƒë·∫ßu
        panda.style.top = (-150 - Math.random()*300) + "px";

        // random size
        const size = 70 + Math.random()*60;
        panda.style.width = size + "px";

        panda.style.pointerEvents = "none";
        panda.style.zIndex = "5000";

        panda.style.filter =
        "drop-shadow(0 18px 35px rgba(0,0,0,0.45)) drop-shadow(0 0 25px rgba(255,182,193,0.7))";

       // random th·ªùi gian r∆°i
const duration = 3 + Math.random()*2;

// random delay
const delay = Math.random()*2;

// animation
panda.style.animation =
`pandaRain ${duration}s ease-in ${delay}s forwards`;



        document.body.appendChild(panda);

        setTimeout(()=>{
            panda.remove();
        }, (duration+delay)*1000);
    }
}










/* üíå 50 tick */
if(loveScore % 50 === 0 && loveScore !== 0){



    const special=document.createElement("div");
    special.textContent =
    "Em y√™u c·ª•c c∆∞ng nhi·ªÅu h∆°n s·ªë l·∫ßn c∆∞ng tick lu√¥n ·ªõüíó";

    special.style.position="fixed";
    special.style.top="35%";
    special.style.left="50%";
    special.style.transform="translate(-50%,-50%)";

    special.style.padding="18px 28px";
    special.style.borderRadius="25px";

    special.style.background=
"linear-gradient(135deg,#fff9fc,#ffe4f2,#ffd6ec)";

special.style.textShadow=
"0 0 12px rgba(255,182,193,0.6)";


    special.style.color="#d63384";

    special.style.fontSize="24px";
    special.style.fontWeight="600";

    special.style.boxShadow="0 15px 40px rgba(255,105,180,0.25)";
    special.style.zIndex="9999";

    special.style.animation="popSoft 0.5s ease";

    document.body.appendChild(special);

    setTimeout(()=>special.remove(),3000);
}




    /* ================= EFFECT PH√ÇN C·∫§P ================= */

    // 1-2 l·∫ßn: bounce nh·∫π nh∆∞ hi·ªán t·∫°i
    if(count <= 2){

        const dx = rand(-40,40) + "px";
        const dy = rand(-50,-20) + "px";

        sticker.style.transition = "transform 0.25s ease";
        sticker.style.transform = `translate(${dx}, ${dy}) scale(1.25)`;

        setTimeout(()=>{
            sticker.style.transform = "translate(0,0) scale(1)";
        },250);
    }

  else if(count === 3){

    sticker.style.animation = "none";
    sticker.style.opacity = "1";

    void sticker.offsetWidth;

    sticker.classList.add("charge-effect");
    sticker.style.filter = "drop-shadow(0 0 25px hotpink)";

    setTimeout(()=>{
        sticker.classList.remove("charge-effect");
        sticker.style.filter = "";
        sticker.style.animation = "";
    },600);
}

else if(count === 4){

    sticker.style.animation = "none";
    sticker.style.opacity = "1";

    void sticker.offsetWidth;

    sticker.classList.add("pulse-effect");
    sticker.style.filter = "drop-shadow(0 0 35px deeppink)";

    const ring = document.createElement("div");
    ring.className = "ripple";
    ring.style.left = x + "px";
    ring.style.top = y + "px";
    ring.style.background = "rgba(255,105,180,0.25)";
    document.body.appendChild(ring);
    setTimeout(()=>ring.remove(),800);

    setTimeout(()=>{
        sticker.classList.remove("pulse-effect");
        sticker.style.filter = "";
        sticker.style.animation = "";
    },500);
}

    // 5 l·∫ßn: B√ôNG N·ªî T√åNH Y√äU üí•
    else if(count === 5){

        for(let i=0;i<25;i++){
            const boom = document.createElement("div");
            boom.className="sparkle";
            boom.textContent="üíñ";
            boom.style.left = x+"px";
            boom.style.top = y+"px";
            boom.style.setProperty("--sx",rand(-220,220)+"px");
            boom.style.setProperty("--sy",rand(-220,220)+"px");
            document.body.appendChild(boom);
            setTimeout(()=>boom.remove(),1000);
        }

        // reset v·ªÅ 0 ƒë·ªÉ c√≥ th·ªÉ ch∆°i l·∫°i
        sticker.dataset.clicks = 0;
    }

    /* ================= TIM KH√ÅC NHAU ================= */

    const heartTypes = ["üíó","üíñ","üíò","üíù","üíû","üíì","üíü"];
    const chosenHeart = heartTypes[randInt(0,heartTypes.length)];

    // Love text
    const div=document.createElement("div");
    div.className="love-text";
    div.textContent=getRandomMessage()+" "+chosenHeart;
// üíó Lu√¥n bay cao h∆°n b√¨nh th∆∞·ªùng
const flyY = rand(-260, -380);   // bay cao h∆°n tr∆∞·ªõc
const flyX = rand(-120, 120);    // bay l·ªách tr√°i/ph·∫£i

div.style.setProperty("--flyX", flyX + "px");
div.style.setProperty("--flyY", flyY + "px");

// üíó Click nhi·ªÅu th√¨ gi·ªØ l√¢u h∆°n m·ªôt ch√∫t
let duration = 1.6;

if(count >= 3){
    duration = 2.1;
}
if(count >= 5){
    duration = 2.6;
}

div.style.animationDuration = duration + "s";
    const color=generateCuteColor();
    div.style.color=color;
    div.style.textShadow=`
        0 3px 8px rgba(0,0,0,0.5),
        0 0 20px ${color}
    `;
    div.style.left=x+"px";
    div.style.top=y+"px";

    document.body.appendChild(div);
    setTimeout(()=>{
    div.remove();
}, duration * 1000);

    // 3 tim bay ‚Äî m·ªói c√°i random
    for(let i=0;i<3;i++){
        const h=document.createElement("div");
        h.className="flying-heart";
        h.textContent=heartTypes[randInt(0,heartTypes.length)];
        h.style.fontSize=rand(24,42)+"px";
        h.style.left=x+"px";
        h.style.top=y+"px";
        h.style.setProperty("--x",rand(-120,120)+"px");
        h.style.setProperty("--y",rand(-180,-80)+"px");
        document.body.appendChild(h);
        setTimeout(()=>h.remove(),1600);
    }
}

function spawnSticker(src,isPanda,position){
    const img=new Image();
    img.src=src;
    img.className="sticker";
    img.dataset.clicks = 0;
    if(isPanda) img.classList.add("panda");

    img.onload=()=>{
        img.style.width = isPanda
    ? rand(100,120) + "px"      // üêº Panda l·ªõn h∆°n ch√∫t
    : rand(115,140) + "px";     // üéÄ Sticker th∆∞·ªùng l·ªõn h∆°n


        img.style.left = position.x + "px";
        img.style.top = position.y + "px";


        img.addEventListener("click",(e)=>{
        showLove(e.clientX,e.clientY, img);
        });

        document.body.appendChild(img);
        setTimeout(()=>img.remove(),4800);
    };
}

function spawnWave(){

    if(pandaPool.length < 5 || normalPool.length < 10){
        initPools();
    }

    const positions = getGridPositions();
    let posIndex = 0;

    // ===== 10 sticker th∆∞·ªùng =====
    for(let i=0;i<10;i++){
    const pos = positions[posIndex++];
    if(!pos) break;   // üëà TH√äM D√íNG N√ÄY

    const id = normalPool.pop();

    spawnSticker(
        `webp-stickers/${id}.webp`,
        false,
        pos
    );
}


    // ===== 5 panda =====
for(let i=0;i<5;i++){
    const pos = positions[posIndex++];
    if(!pos) break;   // üëà TH√äM D√íNG N√ÄY

    const id = pandaPool.pop();


        spawnSticker(
            `webp-stickers-panda/${id}.webp`,
            true,
            pos
        );
    }
}




function startSticker(){
    if(stickerInterval) return;

    document.getElementById("loveBarWrapper").style.opacity = "1";
    document.getElementById("loveBarWrapper").style.pointerEvents = "auto";

    spawnWave();
    stickerInterval = setInterval(spawnWave,4800);
}


window.onload = function(){

    initPools();
    preloadSmart();   // üëà thay d√≤ng n√†y

    typeWriter(
        document.getElementById("text1"),
        "B√© Kei ∆°iii, b√© Kei √≤, b√© Keii c√≥ bi·∫øt h√¥nggg??"
    );
};





/* ================= POPUP FLOW ================= */

function nextPopup(){
    popup1.classList.add("hidden");
    popup2.classList.remove("hidden");

    typeWriter(
    document.getElementById("text2"),
    `Ch·∫Øc l√† b√© Keii h√¥ng bi·∫øt ƒë√¢u haaaa
    
Ch·∫°m ch·∫°m v√†o m·∫•y b√© g·∫•u l√† bi·∫øt li·ªÅn √° ng∆∞·ªùi y√™uuu!`
);


    startSticker();
}



function closePopup(){
    popup2.classList.add("hidden");
    document.body.classList.add("dark");
    envelope.classList.remove("hidden");
    envelope.classList.add("drop");

}

/* ================= LETTER ================= */

const letterParagraphs = [
"Hi t√¨nh y√™u c·ªßa em üíó",

"Sao m√† em ·ªü ƒë√¢u t·ª± nhi√™n xu·∫•t hi·ªán, y√™u ch·ªã qu√° v·∫≠y n√®, em c√≥ th·∫≠t kh√¥ng?üí≠",

"ƒê·ªÉ em n√≥i cho ng∆∞·ªùi y√™u nghe nhaa",

"Tuy l√† c√≥ n√≥i c≈©ng h∆°m c√≥ h·∫øt l√† t·∫°i sao em y√™u ch·ªã ƒë√¢uu c·ª•c c∆∞ngggg üíû",

"C·∫£m ∆°n c·ª•c c∆∞ng ƒë√£ ƒë·∫ønn, ng∆∞·ªùi y√™u ƒë·∫øn l√†m em cu·ªôc s·ªëng c·ªßa em c√≥ nhi·ªÅu ti·∫øng c∆∞·ªùi h∆°n, em n√≥i ra c≈©ng nhi·ªÅu h∆°n, ƒë∆∞·ª£c chia s·∫ª chia s·∫ª. Tuy l√† ng∆∞·ªùi y√™u n√≥i em kh√¥ng ch·ªãu n√≥i chuy·ªán g√¨ ch∆°nn, nh∆∞ng m√† √° ng∆∞·ªùi y√™u em c≈©ng ƒë√£ n√≥i r·ªìi mo√†aa üíì",

"Ng∆∞·ªùi y√™u ∆°ii, em c≈©ng h√¥ng c√≥ n√≥i nhi·ªÅu, mi·ªáng l∆∞·ª°i kh√¥ng c√≥ ƒë∆∞·ª£c ng·ªçt ng√†o ng∆∞·ªùi y√™u ƒë·ª´ng ch√™ em m√† üëâüëà ",

"Em bi·∫øt √°, t√¨nh y√™u c·ªßa em x·ª©ng ƒë√°ng c√≥ ƒë∆∞·ª£c nh·ªØng ƒëi·ªÅu t·ªët ƒë·∫πp nh·∫•t tr√™n th·∫ø gian n√†y lu√¥nn ",

"N√™n l√†... Ahihi ",

"Hello c·ª•c c∆∞ngg nhaa, em c≈©ng ƒë·∫øn r·ªìii üíù",
"Em ƒë·∫øn ƒë√¢y ƒë·ªÉ y√™u th∆∞∆°ng ch·ªã ü§ç",

"Em y√™u c√°ch ch·ªã ƒë·ªÉ √Ω ƒë·∫øn em üíï",
"Em y√™u c√°ch ch·ªã quan t√¢m em üíó",
"Em y√™u c√°ch ch·ªã nu√¥ng chi·ªÅu, ch·ªØa l√†nh cho em üå∑",
"Em y√™u c√°ch ch·ªã y√™u m·ªôt ng∆∞·ªùi b√¨nh th∆∞·ªùng c√≤n nhi·ªÅu thi·∫øu s√≥t nh∆∞ em üíü",

"Em y√™u ch·ªã m·ªói khi nh√¨n ng∆∞·ªùi y√™u c∆∞·ªùii, ng∆∞·ªùi y√™u    C·ªßa em c∆∞·ªùi th√¨ d·ªÖ th∆∞∆°ng c√≤n em th√¨ h·∫°nh ph√∫c, v√¨ ƒë∆∞·ª£c ng·∫Øm ch·ªã üòç",

"Em y√™u ch·ªã m·ªói khi nh√¨n ng∆∞·ªùi y√™u ƒÉn, ng∆∞·ªùi y√™u ng·ªß, ng∆∞·ªùi y√™u c·ªßa em th·∫•y c∆∞ngggg, nh√¨n ngoan ∆°i l√† ngoann, l√†m em ph·∫£i c·∫£m th√°n kh√¥ng bi·∫øt bao nhi√™u l·∫ßn l√† c√°i ng∆∞·ªùi ƒë√°ng y√™u n√†y l√† c·ªßa em. Em ph·∫£i y√™u th∆∞∆°ng ch·ªã bao l√¢u m·ªõi ƒë·ªß ƒë∆∞·ª£c ƒë√¢yy ahh. ü•∞",

"Em y√™u c·∫£ nh·ªØng l√∫c c·ª•c c∆∞ng gi·∫≠n d·ªóii. C·ª•c c∆∞ng ngoann, gi·∫≠n d·ªói th√¨ gi·∫≠n d·ªói ƒë·ª´ng im l·∫∑ng, kh√¥ng mu·ªën quan t√¢m v·ªõi em, em s·∫Ω ƒëau l√≤ng, s·∫Ω t·ªßi th√¢n. ü•∫",

"Em bi·∫øt, ng∆∞·ªùi y√™u d·ªói em c≈©ng kh√≥ ch·ªãu c≈©ng t·ªßi th√¢nn. C·ª•c c∆∞ng ngoann, th∆∞∆°ng em. D·ªói s∆∞∆°ng s∆∞∆°ng th√¥i haa, cho em c·ªông d√¢y v·ªõi ƒë·ªÉ em d·ªó d·ªó ng∆∞·ªùi y√™u. d·ªó xong r·ªìi hai ƒë·ª©a m√¨nh s·∫Ω h√¥ng c√≥ ai ph·∫£i ƒëau l√≤ng n·ªØa lu√¥n √° ng∆∞·ªùi y√™uuuu üíû",

"Ng∆∞·ªùi y√™u ∆°ii, b·∫≠n r·ªôn th√¨ b·∫≠n r·ªôn nh∆∞ng em v·∫´n lu√¥n nghƒ© ƒë·∫øn ng∆∞·ªùi y√™u √°, lu√¥n nh·ªõ ch·ªã, lu√¥n y√™u ch·ªã",
"Ng∆∞·ªùi y√™u y√™n t√¢m nhaa, em lu√¥n lu√¥n c√≥ th·ªùi gian cho ch·ªã m√†. N√™n c≈©ng l√†m phi·ªÅn ng∆∞·ªùi y√™u ch·ªãu kh√≥ y√™u em nhaa, bao dung nh·ªØng l√∫c em ƒë·ªù ƒë·∫´n, kh√¥ng c√≤n t√¢m tr√≠ ƒë·ªÉ l√†m g√¨... üíó",

"Ch·ª•t ch·ª•t ch·ª•ttt üíã",

"Th∆∞·ªüng cho c·ª•c c∆∞ng v√¨ ƒë√£ y√™u em √° üíù",

"T·∫°i y√™u em c≈©ng kh√≥ l·∫Øm √°, h√¥ng c√≥ d·ªÖ ƒë√¢uuu üòö",

"C·ª•c c∆∞ng ∆°ii, em s·∫Ω b√™n ch·ªã th·∫≠t l√¢uuu üíû",

"Ch√∫c ng∆∞·ªùi y√™u valentine‚Äôs thi·ªát l√† h·∫°nh ph√∫c nhaa üíò",

"Em y√™u Ki·ªÅuu! üíñ"

];


envelope.onclick = () => {

    envelope.style.display = "none";

    document.body.classList.add("letter-open");
    letter.classList.add("show");
    document.getElementById("loveBarWrapper").style.opacity = "0";
    document.getElementById("loveBarWrapper").style.pointerEvents = "none";


    bgInterval = setInterval(spawnBgHeart,800);

    (async function(){

        for(const text of letterParagraphs){

    const p = document.createElement("div");
    letterContent.appendChild(p);

    await typeWriter(p, text, 38);

    await new Promise(r => setTimeout(r, 250));

    // üëâ Scroll sau khi g√µ xong m·ªói ƒëo·∫°n
    requestAnimationFrame(() => {
        letterContent.parentElement.scrollTop =
        letterContent.parentElement.scrollHeight;
    });
}
})();
};



closeLetterBtn.onclick = function(){

    clearInterval(bgInterval);

    letter.classList.remove("show");

    document.body.classList.remove("letter-open");
    document.body.classList.remove("dark");
    document.getElementById("loveBarWrapper").style.opacity = "1";
    document.getElementById("loveBarWrapper").style.pointerEvents = "auto";


    letterContent.innerHTML = "";
};



</script>

</body>
</html>



